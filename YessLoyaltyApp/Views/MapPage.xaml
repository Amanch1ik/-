<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
             xmlns:viewmodels="clr-namespace:YessLoyaltyApp.ViewModels"
             x:Class="YessLoyaltyApp.Views.MapPage"
             Title="Карта Партнеров">

    <Grid>
        <maps:Map x:Name="PartnersMap" 
                  MapType="Street"
                  IsShowingUser="True">
            <maps:Map.MapStyle>
                <maps:MapStyle>
                    <maps:MapStyle.CustomStyle>
                        [
                            {
                                "featureType": "poi",
                                "elementType": "labels",
                                "stylers": [
                                    { "visibility": "off" }
                                ]
                            }
                        ]
                    </maps:MapStyle.CustomStyle>
                </maps:MapStyle>
            </maps:Map.MapStyle>
        </maps:Map>

        <VerticalStackLayout 
            Padding="16"
            VerticalOptions="End"
            HorizontalOptions="Fill">
            
            <Border 
                BackgroundColor="White"
                Stroke="Transparent"
                StrokeShape="RoundRectangle 16"
                Padding="16"
                Shadow="{StaticResource DefaultShadow}">
                
                <VerticalStackLayout Spacing="8">
                    <Label 
                        Text="Ближайшие партнеры"
                        FontSize="18"
                        FontAttributes="Bold"
                        HorizontalOptions="Center"/>
                    
                    <CollectionView 
                        ItemsSource="{Binding NearbyPartners}"
                        HeightRequest="200">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8">
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MapViewModel}}, Path=NavigateToPartnerCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Grid.GestureRecognizers>
                                    
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Image 
                                        Grid.Column="0"
                                        Source="{Binding LogoUrl}"
                                        WidthRequest="50"
                                        HeightRequest="50"
                                        Aspect="AspectFit"/>
                                    
                                    <VerticalStackLayout Grid.Column="1" Padding="8,0">
                                        <Label 
                                            Text="{Binding Name}"
                                            FontAttributes="Bold"/>
                                        <Label 
                                            Text="{Binding Address}"
                                            TextColor="Gray"
                                            FontSize="12"/>
                                    </VerticalStackLayout>
                                    
                                    <Label 
                                        Grid.Column="2"
                                        Text="{Binding CashbackRate, StringFormat='{0}% кешбэк'}"
                                        TextColor="{StaticResource PrimaryColor}"
                                        VerticalOptions="Center"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>

        <Button 
            Text="Проложить маршрут"
            Command="{Binding BuildRouteCommand}"
            BackgroundColor="{StaticResource PrimaryColor}"
            TextColor="White"
            CornerRadius="16"
            Margin="16"
            VerticalOptions="End"
            HorizontalOptions="Center"/>
    </Grid>
</ContentPage>
